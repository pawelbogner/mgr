\chapter{Endogenous configuration space}
\label{ch:endogen}
\section{Basic concepts}
Let us consider a mobile robot --- a mobile platform with a manipulator. Let $q = (w, \dot w)^T \in \mathbb{R}^{2n}$ denote the state of the platform and $x \in \mathbb{R}^p$ denote the configuration of the manipulator. The platform is actuated by vector $u \in \mathbb{R}^m$. We can define a vector $y \in \mathbb{R}^r$ which is the result of the output function $k: \mathbb{R}^{2n} \times \mathbb{R}^p \rightarrow \mathbb{R}^r$. 

Suppose the dynamics of the platform are defined by the equation obtained using Euler-Lagrange formalism:
\begin{equation}
Q(w)\ddot w + C(w, \dot{w})\dot{w}+D(w)=F(w, \dot w)+B(w)u,
\end{equation}
where $Q(w)$ is the inertia matrix, $C(w, \dot w)$ is the centripetal and Coriolis forces matrix,
$D(w)$ is the potential forces vector, $F(w, \dot w)$ is the vector of traction forces and $u$ is the
control forces vector applied to the system having been transformed by matrix $B(w)$.
This system may be transformed into the form $\dot q = f(q) + G(q)u$ using
\begin{equation}
\begin{aligned}
f(q)&=\begin{bmatrix}
\dot{w}\\
Q^{-1}(w)\left(F(w, \dot w)-C(w, \dot{w})\dot{w}-D(w)\right)
\end{bmatrix}, & G(q)&=\begin{bmatrix}
0_{n\times m}\\
Q^{-1}B
\end{bmatrix}
\end{aligned}
\end{equation}

Adding to the above the output function depending on the platform state and the configuration of the manipulator gives the following affine control system with inputs
$u \in \mathbb{R}^m$, $x \in \mathbb{R}^p$ and output function $k$.
\begin{equation}
\begin{cases}
\begin{aligned}
\label{eq:control_sys}
\dot q &= f(q) + G(q)u,\\
y &= k(q, x).
\end{aligned}
\end{cases}
\end{equation}

\subsection{Endogenous configuration}
Define a pair $(u(\cdot), x)$, which consists of control inputs mentioned above.
Such elements belong to the endogenous configuration space
$\mathcal{X} = L_m^2[0, T] \times \mathbb{R}^p$ of the mobile manipulator.
The inner product in $\mathcal{X}$ is as follows \cite{ecs_ijc}:
\begin{equation}
\langle (u_1(\cdot), x_1), (u_2(\cdot), x_2) \rangle = \int_0^T u_1^T(t) u_2(t) \ud t + x_1^T x_2.
\end{equation}

The function
$K_{q_0, T}: \mathcal{X} \rightarrow \mathbb{R}^r$
allow to determine the state of the mobile manipulator at time $T>0$ given
endogenous configuration $(u(\cdot), x)$ and initial state $q_0$:
\begin{equation}
K_{q_0, T}((u(\cdot), x)) = k(\phi_{q_0, T}(u(\cdot)), x),
\end{equation}
where $\phi_{q_0, T}(u(\cdot))$ denotes the flow of the system \eqref{eq:control_sys}
caused by input $u(\cdot)$. The above will be called the end-point map.

With the above definitions the analytic Jacobian of $K_{q_0, T}$ can be defined at $(u(\cdot), x) \in \mathcal{X}$:
\begin{align}
J_{q_0, T}(u(\cdot), x)(v(\cdot), w) &= \left.\frac{\ud}{\ud \alpha}\right|_{\alpha=0} K_{q_0, T}((u(\cdot)+\alpha v(\cdot), x+\alpha w))\\
 &= \begin{bmatrix}
 C(T,x)\int_0^T \Phi(T,s)B(s)v(s)\ud s & D(T,x)w \end{bmatrix} ,
\end{align}
where $(v(\cdot), w)\in \mathcal{X}$ and $\Phi(T,s)$ is the fundamental matrix of the following system:
\begin{equation}
\begin{aligned}
\label{eq:abxi}
\dot \xi &= A(t)\xi + B(t) v \\
\eta &= C(t, x)\xi + D(t, x).
\end{aligned}
\end{equation}
The matrices in \eqref{eq:abxi} are as follows:
\begin{equation}
\begin{aligned}
A(t) &= \frac{\partial (f(q(t))+G(q(t))u(t)}{\partial q}, & B(t) &= G(q(t)),\\
C(t, x) &= \frac{\partial k(q(t), x)}{\partial q}, & D(t(t), x) &= \frac{\partial k(q(t), x)}{\partial x}.
\end{aligned}
\end{equation}

\section{Motion planning algorithm}

\section{Computations}
The dimension of $L^2[0,T]$ space is infinite. Therefore we need an infinite number of parameters to define an element from this space. This is impossible to achieve in calculations made on a computer. The solution is to limit the bandwidth of considered functions. 

It is possible to choose a finite-dimensional base $\Phi = [ \phi_1, \phi_2, \dots, \phi_s ]$ spanning the limited-band control functions space. 
With such approach a function $u_i$ is represented by a vector 
$\lambda_i = [\lambda_{i1}, \lambda_{i2}, \dots, \lambda_{is}]^T$ 
which satisfies the formula $u_i = \sum_{k=1}^s \phi_k \lambda_{ik}$.

In order to define a vector $u=[u_1, u_2, \dots, u_m]^T$ a matrix $P(t)$ should be defined, such that $u(t)=P(t)\lambda$. This means $P(t)$ is a block diagonal matrix 
\begin{equation}
P(t)=\begin{bmatrix}
\Phi & 0 & \cdots & 0\\
0 & \Phi & \ddots & \vdots\\
\vdots & \ddots & \ddots & 0 \\
0 &  \cdots & 0 & \Phi
\end{bmatrix}
\end{equation}

Assuming the above the Jacobian $J_{q_0, T}(u(\cdot), x)$ may be computed as $\begin{bmatrix}
C\cdot\Xi(T)& D
\end{bmatrix}$, where $\Xi$ is defined by an ODE $\dot \Xi = A(t)\Xi +B(t)P(t)$ with the initial condition $\Xi(0)=0$ [TODO: citation needed]. This allows easily calculate the Jacobian during the simulation of the system by extending the ODE function.
